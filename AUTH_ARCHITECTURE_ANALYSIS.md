# üîê –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üìã –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏:

### üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–æ–≤

```
stormlink/
‚îú‚îÄ‚îÄ server/           # GraphQL API Gateway
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ auth/         # –°–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ user/         # –°–µ—Ä–≤–∏—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ mail/         # –°–µ—Ä–≤–∏—Å –ø–æ—á—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ media/        # –°–µ—Ä–≤–∏—Å –º–µ–¥–∏–∞
‚îî‚îÄ‚îÄ shared/           # –û–±—â–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    ‚îú‚îÄ‚îÄ auth/         # –ö–æ–Ω—Ç–µ–∫—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    ‚îú‚îÄ‚îÄ jwt/          # JWT —É—Ç–∏–ª–∏—Ç—ã
    ‚îî‚îÄ‚îÄ http/         # HTTP —É—Ç–∏–ª–∏—Ç—ã
```

## üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

### 1. **JWT –¢–æ–∫–µ–Ω—ã**

**–¢–∏–ø—ã —Ç–æ–∫–µ–Ω–æ–≤:**
- **Access Token** (15 –º–∏–Ω—É—Ç) - –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
- **Refresh Token** (7 –¥–Ω–µ–π) - –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è access —Ç–æ–∫–µ–Ω–∞

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤:**
```json
{
  "user_id": "1",
  "exp": 1734567890,
  "type": "access|refresh"
}
```

### 2. **–ü–æ—Ç–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**

```
1. Login Request ‚Üí Auth Service
2. Validate Credentials ‚Üí Database
3. Generate JWT Tokens ‚Üí Shared/JWT
4. Set Cookies ‚Üí Shared/HTTP
5. Return Tokens ‚Üí Client
```

### 3. **Middleware –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**

**HTTPAuthMiddleware** (`server/middleware/http_auth.go`):
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ `Authorization` –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏–ª–∏ –∫—É–∫–∏ `auth_token`
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ gRPC –≤—ã–∑–æ–≤ –∫ Auth Service
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `userID` –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ `sharedauth.WithUserID()`

### 4. **Auth Service** (`services/auth/`)

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
- `Login()` - –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `ValidateToken()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è access —Ç–æ–∫–µ–Ω–∞
- `RefreshToken()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- `GetMe()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `Logout()` - –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Redis –¥–ª—è revoke —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è refresh —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ HTTP –∫—É–∫–∏
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è email –ø–µ—Ä–µ–¥ –≤—Ö–æ–¥–æ–º

## üõ°Ô∏è –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### 1. **–°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π**

**–£—Ä–æ–≤–Ω–∏ —Ä–æ–ª–µ–π:**
- **Host Roles** - —Ä–æ–ª–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- **Community Roles** - —Ä–æ–ª–∏ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞—Ö

**–ü—Ä–∞–≤–∞ —Ä–æ–ª–µ–π:**
```go
// Host Roles
- communityRolesManagement
- hostUserBan
- hostUserMute
- hostCommunityPostDelete
- hostCommunityCommentsDelete

// Community Roles  
- communityRolesManagement
- communityUserBan
- communityUserMute
- communityDeletePost
- communityDeleteComments
```

### 2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤**

**–í —Ä–µ–∑–æ–ª–≤–µ—Ä–∞—Ö:**
```go
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
if cm.OwnerID != currentUserID {
    permsMap, err := r.UserUC.GetPermissionsByCommunities(ctx, currentUserID, []int{cid})
    perms := permsMap[cid]
    if perms == nil || !perms.CommunityRolesManagement {
        return nil, fmt.Errorf("forbidden")
    }
}
```

### 3. **–°–∏—Å—Ç–µ–º–∞ –±–∞–Ω–æ–≤ –∏ –º—É—Ç–æ–≤**

**–¢–∏–ø—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π:**
- `HostUserBan` - –±–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- `HostCommunityBan` - –±–∞–Ω —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- `CommunityUserBan` - –±–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ
- `CommunityUserMute` - –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. **–ö–æ–Ω—Ç–µ–∫—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** (`shared/auth/`)

```go
// –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–ª—é—á –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
type typedKey struct{ name string }
var userIDKey = typedKey{name: "userID"}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ userID –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
func WithUserID(ctx context.Context, id int) context.Context

// –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ userID –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
func UserIDFromContext(ctx context.Context) (int, error)
```

### 2. **JWT —É—Ç–∏–ª–∏—Ç—ã** (`shared/jwt/`)

```go
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
func GenerateAccessToken(userID int) (string, error)
func GenerateRefreshToken(userID int) (string, error)

// –ü–∞—Ä—Å–∏–Ω–≥ —Ç–æ–∫–µ–Ω–æ–≤
func ParseAccessToken(tokenString string) (*AccessTokenClaims, error)
func ParseRefreshToken(tokenString string) (*RefreshTokenClaims, error)
```

### 3. **HTTP —É—Ç–∏–ª–∏—Ç—ã** (`shared/http/`)

```go
// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫—É–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
func SetAuthCookies(w http.ResponseWriter, accessToken, refreshToken string)

// –û—á–∏—Å—Ç–∫–∞ –∫—É–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
func ClearAuthCookies(w http.ResponseWriter)
```

## ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### 1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**
- ‚úÖ Auth Service –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
- ‚úÖ GraphQL Server - API Gateway
- ‚úÖ Shared –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
- ‚úÖ JWT —Å –∫–æ—Ä–æ—Ç–∫–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏ (15 –º–∏–Ω)
- ‚úÖ Refresh —Ç–æ–∫–µ–Ω—ã —Å —Ä–æ—Ç–∞—Ü–∏–µ–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ revoke —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ Redis
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è email –ø–µ—Ä–µ–¥ –≤—Ö–æ–¥–æ–º

### 3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**
- ‚úÖ –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ gRPC –¥–ª—è –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- ‚úÖ Redis –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏

### 4. **–ì–∏–±–∫–æ—Å—Ç—å**
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π —Å –≥—Ä–∞–Ω—É–ª—è—Ä–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–∞–Ω–æ–≤ –∏ –º—É—Ç–æ–≤ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω—è—Ö
- ‚úÖ –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

## ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
- üîÑ –î–æ–±–∞–≤–∏—Ç—å rate limiting –¥–ª—è auth endpoints
- üîÑ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å 2FA (–¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é)
- üîÑ –î–æ–±–∞–≤–∏—Ç—å –∞—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
- üîÑ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üîÑ Batch –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
- üîÑ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### 3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
- üîÑ –ú–µ—Ç—Ä–∏–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—É—Å–ø–µ—à–Ω—ã–µ/–Ω–µ—É—Å–ø–µ—à–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏)
- üîÑ –ê–ª–µ—Ä—Ç—ã –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- üîÑ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ security events

### 4. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**
- üîÑ API Gateway –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- üîÑ Service Mesh –¥–ª—è –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- üîÑ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. **–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**
- –î–æ–±–∞–≤–∏—Ç—å rate limiting
- –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏

### 2. **–°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å 2FA
- –î–æ–±–∞–≤–∏—Ç—å –∞—É–¥–∏—Ç
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### 3. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**
- Service Mesh
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π API Gateway
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π

## üìä –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ **—Ö–æ—Ä–æ—à–æ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞** –∏ —Å–ª–µ–¥—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º:

‚úÖ **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏  
‚úÖ **JWT-based –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** —Å refresh —Ç–æ–∫–µ–Ω–∞–º–∏  
‚úÖ **–ì—Ä–∞–Ω—É–ª—è—Ä–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –±–∞–Ω–æ–≤ –∏ –º—É—Ç–æ–≤  
‚úÖ **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç** –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ userID  
‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Redis** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏  

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–ª—É—á—à–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–ª–æ–µ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.
