#!/bin/bash

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ—Å—Ç–≤"
echo "=============================================="

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
test_query() {
    local name="$1"
    local query="$2"
    local expected_error="$3"
    
    echo -e "\n${YELLOW}–¢–µ—Å—Ç: $name${NC}"
    echo "–ó–∞–ø—Ä–æ—Å: $query"
    
    response=$(curl -s -X POST http://localhost:8080/query \
        -H "Content-Type: application/json" \
        -d "{\"query\": \"$query\"}" | sed 's/"/\\"/g')
    
    echo "–û—Ç–≤–µ—Ç: $response"
    
    if [ -n "$expected_error" ]; then
        if echo "$response" | grep -q "$expected_error"; then
            echo -e "${GREEN}‚úÖ –û–∂–∏–¥–∞–µ–º–∞—è –æ—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞: $expected_error${NC}"
        else
            echo -e "${RED}‚ùå –û–∂–∏–¥–∞–µ–º–∞—è –æ—à–∏–±–∫–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞${NC}"
        fi
    else
        if echo "$response" | grep -q "errors"; then
            echo -e "${RED}‚ùå –ü–æ–ª—É—á–µ–Ω–∞ –æ—à–∏–±–∫–∞${NC}"
        else
            echo -e "${GREEN}‚úÖ –£—Å–ø–µ—à–Ω–æ${NC}"
        fi
    fi
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞..."
if ! curl -s http://localhost:8080/query > /dev/null; then
    echo -e "${RED}‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ localhost:8080${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω${NC}"

# –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ (–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
test_query \
    "–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ—Å—Ç–≤–∞" \
    "query { communityRules(communityID: \"1\") { id title description createdAt } }" \
    "unauthorized"

# –¢–µ—Å—Ç 2: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
test_query \
    "–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏" \
    "mutation { createCommunityRule(input: { communityID: \"1\", title: \"–¢–µ—Å—Ç\", description: \"–û–ø–∏—Å–∞–Ω–∏–µ\" }) { id title } }" \
    "unauthorized"

# –¢–µ—Å—Ç 3: –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ (–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
test_query \
    "–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞" \
    "query { communityRule(id: \"1\") { id title description } }" \
    "unauthorized"

echo -e "\n${GREEN}‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ${NC}"
echo -e "\n${YELLOW}–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í—Å–µ —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, —Ç–∞–∫ –∫–∞–∫ –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±–µ–∑ —Ç–æ–∫–µ–Ω–∞.${NC}"
echo -e "${YELLOW}–î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:${NC}"
echo -e "${YELLOW}1. –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é: psql -h localhost -U postgres -d stormlink -f migrate_community_rules.sql${NC}"
echo -e "${YELLOW}2. –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏${NC}"
echo -e "${YELLOW}3. –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Å —Ç–æ–∫–µ–Ω–æ–º${NC}"
