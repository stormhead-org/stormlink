#!/bin/bash

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, –º—É—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–æ–æ–±—â–µ—Å—Ç–≤

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
SERVER_URL="http://localhost:8080"
COOKIES_FILE="platform_test_cookies.txt"

echo -e "${BLUE}üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã${NC}"
echo "=================================================="

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è GraphQL –∑–∞–ø—Ä–æ—Å–æ–≤
execute_query() {
    local query="$1"
    local description="$2"
    
    echo -e "\n${YELLOW}üîç $description${NC}"
    echo "Query: $query"
    
    response=$(curl -s -X POST "$SERVER_URL/query" \
        -H "Content-Type: application/json" \
        -b "$COOKIES_FILE" \
        -d "{\"query\": \"$query\"}")
    
    echo "Response: $response"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—à–∏–±–∫–∏
    if echo "$response" | grep -q '"errors"'; then
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ${NC}"
        return 1
    else
        echo -e "${GREEN}‚úÖ –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ${NC}"
        return 0
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è GraphQL –º—É—Ç–∞—Ü–∏–π
execute_mutation() {
    local mutation="$1"
    local description="$2"
    
    echo -e "\n${YELLOW}üîß $description${NC}"
    echo "Mutation: $mutation"
    
    response=$(curl -s -X POST "$SERVER_URL/query" \
        -H "Content-Type: application/json" \
        -b "$COOKIES_FILE" \
        -d "{\"query\": \"$mutation\"}")
    
    echo "Response: $response"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—à–∏–±–∫–∏
    if echo "$response" | grep -q '"errors"'; then
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –≤ –º—É—Ç–∞—Ü–∏–∏${NC}"
        return 1
    else
        echo -e "${GREEN}‚úÖ –ú—É—Ç–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ${NC}"
        return 0
    fi
}

# 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
echo -e "\n${BLUE}1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã${NC}"
echo "=========================================="

login_response=$(curl -s -X POST "$SERVER_URL/query" \
    -H "Content-Type: application/json" \
    -c "$COOKIES_FILE" \
    -d '{
        "query": "mutation { loginUser(input: { email: \"gamenimsi@gmail.com\", password: \"qqwdqqwd\" }) { user { id name email } } }"
    }')

echo "Login response: $login_response"

if echo "$login_response" | grep -q '"errors"'; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏${NC}"
    exit 1
else
    echo -e "${GREEN}‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞${NC}"
fi

# 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ö–æ—Å—Ç–µ
echo -e "\n${BLUE}2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ö–æ—Å—Ç–µ${NC}"
echo "====================================="

execute_query "query { host { id title slogan description owner { id name } } }" \
    "–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ö–æ—Å—Ç–µ"

# 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
echo -e "\n${BLUE}3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã${NC}"
echo "====================================="

# 3.1 –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–∞–≤–∏–ª
execute_query "query { hostRules { id title description createdAt } }" \
    "–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã"

# 3.2 –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞
execute_mutation "mutation { createHostRule(input: { title: \"–£–≤–∞–∂–µ–Ω–∏–µ –∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º\", description: \"–ó–∞–ø—Ä–µ—â–µ–Ω—ã –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏ –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏—è\" }) { id title description createdAt } }" \
    "–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã"

# 3.3 –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
execute_query "query { hostRules { id title description createdAt } }" \
    "–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è"

# 3.4 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
execute_query "query { hostRules { id title } }" \
    "–ü–æ–ª—É—á–µ–Ω–∏–µ ID –ø—Ä–∞–≤–∏–ª –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"

# –ò–∑–≤–ª–µ–∫–∞–µ–º ID –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
rule_id=$(curl -s -X POST "$SERVER_URL/query" \
    -H "Content-Type: application/json" \
    -b "$COOKIES_FILE" \
    -d '{"query": "query { hostRules { id } }"}' | \
    grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)

if [ ! -z "$rule_id" ]; then
    execute_mutation "mutation { updateHostRule(input: { id: \"$rule_id\", title: \"–û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã\", description: \"–ü—Ä–∞–≤–∏–ª–æ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ\" }) { id title description updatedAt } }" \
        "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã"
fi

# 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º—É—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
echo -e "\n${BLUE}4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º—É—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π${NC}"
echo "====================================="

# 4.1 –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º—É—Ç–æ–≤
execute_query "query { hostUserMutes { id createdAt } }" \
    "–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º—É—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"

# 4.2 –ú—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID 2)
execute_mutation "mutation { muteUserOnHost(input: { userID: \"2\" }) { id createdAt } }" \
    "–ú—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID 2"

# 4.3 –ü–æ–ª—É—á–µ–Ω–∏–µ –º—É—Ç–æ–≤ –ø–æ—Å–ª–µ –º—É—Ç–∞
execute_query "query { hostUserMutes { id createdAt } }" \
    "–ü–æ–ª—É—á–µ–Ω–∏–µ –º—É—Ç–æ–≤ –ø–æ—Å–ª–µ –º—É—Ç–∞"

# 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º—É—Ç–æ–≤ —Å–æ–æ–±—â–µ—Å—Ç–≤
echo -e "\n${BLUE}5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º—É—Ç–æ–≤ —Å–æ–æ–±—â–µ—Å—Ç–≤${NC}"
echo "====================================="

# 5.1 –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º—É—Ç–æ–≤ —Å–æ–æ–±—â–µ—Å—Ç–≤
execute_query "query { hostCommunityMutes { id communityID createdAt } }" \
    "–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º—É—Ç–æ–≤ —Å–æ–æ–±—â–µ—Å—Ç–≤"

# 5.2 –ú—É—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ (—Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ —Å ID 1)
execute_mutation "mutation { muteCommunityOnHost(input: { communityID: \"1\" }) { id communityID createdAt } }" \
    "–ú—É—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ —Å ID 1"

# 5.3 –ü–æ–ª—É—á–µ–Ω–∏–µ –º—É—Ç–æ–≤ —Å–æ–æ–±—â–µ—Å—Ç–≤ –ø–æ—Å–ª–µ –º—É—Ç–∞
execute_query "query { hostCommunityMutes { id communityID createdAt } }" \
    "–ü–æ–ª—É—á–µ–Ω–∏–µ –º—É—Ç–æ–≤ —Å–æ–æ–±—â–µ—Å—Ç–≤ –ø–æ—Å–ª–µ –º—É—Ç–∞"

# 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–Ω–æ–≤ (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)
echo -e "\n${BLUE}6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–Ω–æ–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã${NC}"
echo "====================================="

# 6.1 –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
execute_query "query { hostUsersBan { id createdAt } }" \
    "–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"

# 6.2 –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤
execute_query "query { hostCommunityBans { id communityID createdAt } }" \
    "–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤"

# 7. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
echo -e "\n${BLUE}7. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞${NC}"
echo "========================"

# 7.1 –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª
execute_query "query { hostRules { id title description } }" \
    "–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª"

# 7.2 –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º—É—Ç–æ–≤
execute_query "query { hostUserMutes { id } }" \
    "–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –º—É—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"

execute_query "query { hostCommunityMutes { id communityID } }" \
    "–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –º—É—Ç–æ–≤ —Å–æ–æ–±—â–µ—Å—Ç–≤"

echo -e "\n${GREEN}üéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
echo "=================================================="

# –û—á–∏—Å—Ç–∫–∞
rm -f "$COOKIES_FILE"

echo -e "${BLUE}üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:${NC}"
echo "- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã"
echo "- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ö–æ—Å—Ç–µ"
echo "- ‚úÖ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã"
echo "- ‚úÖ –ú—É—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
echo "- ‚úÖ –ú—É—Ç—ã —Å–æ–æ–±—â–µ—Å—Ç–≤"
echo "- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞–Ω–æ–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã"
echo "- ‚úÖ –í—Å–µ GraphQL –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
