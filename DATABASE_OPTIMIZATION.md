# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è PostgreSQL –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ "too many clients already"

## –ü—Ä–æ–±–ª–µ–º–∞

–û—à–∏–±–∫–∞ `pq: sorry, too many clients already` –≤–æ–∑–Ω–∏–∫–ª–∞ –∏–∑-–∑–∞:

1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π PostgreSQL
2. –ò–∑–±—ã—Ç–æ—á–Ω—ã—Ö eager-loading –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö (`WithAuthor()`, `WithCommunity()`, `WithPost()`)
3. –ö–∞—Å–∫–∞–¥–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î –≤ GraphQL —Ä–µ–∑–æ–ª–≤–µ—Ä–∞—Ö

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π PostgreSQL

–í `server/cmd/modules/database.go` –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–ª–∞:

```go
// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
DB_MAX_OPEN_CONNS=15          # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 15)
DB_MAX_IDLE_CONNS=5           # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ idle —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5)
DB_CONN_MAX_LIFETIME_MINUTES=5 # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ –º–∏–Ω—É—Ç–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5)
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è production:**

- `DB_MAX_OPEN_CONNS=25` - –¥–ª—è —Å—Ä–µ–¥–Ω–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏
- `DB_MAX_IDLE_CONNS=10` - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- `DB_CONN_MAX_LIFETIME_MINUTES=10` - –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è CommentUsecase

–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ `GetCommentsByPostIDLight()` –∫–æ—Ç–æ—Ä—ã–π:

- –£–±–∏—Ä–∞–µ—Ç `WithAuthor()`, `WithCommunity()`, `WithPost()`
- –û—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ `WithMedia()` –¥–ª—è URL –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤
- –°–Ω–∏–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ JOIN-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ PostgreSQL

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ GraphQL —Ä–µ–∑–æ–ª–≤–µ—Ä–∞

`CommentsByPostID` —Ä–µ–∑–æ–ª–≤–µ—Ä —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±–ª–µ–≥—á–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é:

```go
return r.CommentUC.GetCommentsByPostIDLight(ctx, pid, hasDeleted)
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞)

```graphql
query GetCommentsByPostId($id: String!) {
	commentsByPostId(id: $id) {
		id
		content
		createdAt
		authorId
		parentCommentId
		media {
			id
			url
		}
	}
}
```

### –î–ª—è –∞–¥–º–∏–Ω–∫–∏ (–ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `GetCommentsByPostID()` –Ω–∞–ø—Ä—è–º—É—é –≤ usecase –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

## Monitoring

–î–æ–±–∞–≤–ª–µ–Ω—ã –ª–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—É–ª–∞:

```
üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–ª–∞ –ë–î: MaxOpen=15, MaxIdle=5, MaxLifetime=5–º
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ PostgreSQL:**

   ```sql
   SELECT count(*) as current_connections
   FROM pg_stat_activity
   WHERE state = 'active';
   ```

2. **–£–≤–µ–ª–∏—á–µ–Ω–∏–µ max_connections –≤ PostgreSQL** (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):

   ```sql
   ALTER SYSTEM SET max_connections = 200;
   SELECT pg_reload_conf();
   ```

3. **DataLoader –¥–ª—è GraphQL** - —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–∞—Ç—á-–∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Redis** - –¥–æ–±–∞–≤—å—Ç–µ –∫—ç—à –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
